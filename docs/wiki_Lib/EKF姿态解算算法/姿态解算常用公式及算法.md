# 姿态解算常用算法公式

## 一、四元数微分方程公式
$ 
\dot{q}_n^b = \frac{1}{2}\Omega_{nb}^n q_n^b$

其中：

$\Omega_{nb}^n = \left[\begin{matrix}0 &-w_x &-w_y &-w_z\\
w_x &0&w_z&-w_y\\
w_y&-w_z&0&w_x\\
w_z&w_y&-w_x&0 
\end{matrix}\right] $

**微分方程展开形式有两种**

形式一：
$
\left[ 
\begin{matrix}\dot{q}_0\\ \dot{q}_1\\ \dot{q}_2\\ \dot{q}_3
\end{matrix}
\right]= \frac{1}{2}\left[\begin{matrix}0 &-w_x &-w_y &-w_z\\
w_x &0&w_z&-w_y\\
w_y&-w_z&0&w_x\\
w_z&w_y&-w_x&0 
\end{matrix}\right]
\left[ 
\begin{matrix}q_0\\q_1\\q_2\\q_3
\end{matrix} \right]
$
形式二：
$
\left[ 
\begin{matrix}\dot{q}_0\\ \dot{q}_1\\ \dot{q}_2\\ \dot{q}_3
\end{matrix}
\right]= \frac{1}{2}\left[\begin{matrix} q_0 &-q_1 &-q_2 &-q_3\\
q_1 &q_0&-q_3&q_2\\
q_2&q_3&q_0&-q_1\\
q_3&-q_2&q_1&q_0 
\end{matrix}\right]
\left[ 
\begin{matrix}0\\w_x\\w_y\\w_z
\end{matrix} \right]
$
$w_x,w_y,w_z$为三轴角速度

$n$为导航坐标系（飞控一般是大地坐标系），
$b$为载体坐标系（飞控一般为机体坐标系）

## 二、由加速计和磁力计值计算欧拉角

$roll  = asin \frac{ay}{\sqrt{a_x^2+a_y^2+a_z^2}}$

$pitch = atan \frac{-a_x}{a_z} = atan2(-a_x,a_z)$

$yaw = atan2(m_y^n,m_x^n)$
 
 其中：

$m_y^n = m_x^bcos(p)+m_z^bsin(p)$

$m_y^n = m_x^bsin(p)sin(r) + m_y^bcos(r)-m_z^bcos(p)sin(r)$

定义：

1. $roll,pitch,yaw$分别是绕$x,y,z$轴旋转的横滚角、俯仰角、偏航角，在三角函数中简写分别为$r,p,y$
2. $m_x^n,m_y^n$分别为大地坐标系下$x,y$轴方向磁力值
3. $m_x^b,m_y^b,m_z^b$分别为机体坐标系下$x,y，z$轴方向磁力值

## 三、由欧拉角计算四元数
公式为：

$q_0 = cos(\frac{p}{2})cos(\frac{r}{2})cos(\frac{y}{2}) - sin(\frac{p}{2})sin(\frac{r}{2})sin(\frac{y}{2})$

$q_1 = cos(\frac{r}{2})cos(\frac{y}{2})sin(\frac{p}{2}) - cos(\frac{p}{2})sin(\frac{r}{2})sin(\frac{y}{2})$

$q_2 = cos(\frac{p}{2})cos(\frac{y}{2})sin(\frac{r}{2}) + cos(\frac{r}{2})sin(\frac{p}{2})sin(\frac{y}{2})$

$q_3= cos(\frac{p}{2})cos(\frac{r}{2})sin(\frac{y}{2}) + cos(\frac{y}{2})sin(\frac{p}{2})sin(\frac{r}{2})$

其中：
$p,r,y$分别是$roll,pitch,yaw$的简写

## 四、由四元数计算欧拉角
公式为：

$roll= atan \frac{2(q_0q_1+q_2q_3)}{1-2(q_1^2+q_2^2)}=atan2(2(q_0q_1+q_2q_3),1-2(q_1^2+q_2^2))$

$pitch = asin(2(q_0q_2-q_3q_1))$

$yaw=atan \frac{2(q_0q_3+q_1q_2}{1-2(q_2^2+q_3^2)}=atan2(2(q_0q_3+q_1q_2),1-2(q_2^2+q_3^2))$

## 五、由四元数定义的旋转矩阵

向量由n坐标系旋转到b坐标系下旋转矩阵为：
$
R_n^b = \left[\begin{matrix} 1-2(q_2^2+q_3^2)&2(q_1q_2-q_0q_3)&2(q_0q_2+q_1q_3)\\
2(q_1q_2+q_0q_3)&1-2(q_1^2+q_3^2)&2(q_2q_3-q_0q_1)\\
2(q_1q_3-q_0q_2)&2(q_0q_1+q_2q_3)&1-2(q_1^2+q_2^2)
\end{matrix}\right]
$

$
R_b^n = {R_n^b}^T$

## 六、由欧拉角定义的旋转矩阵

公式为：
$
R_b^n = \left[\begin{matrix} c_yc_z&c_zs_xs_y-c_xs_z&s_xs_z+c_xc_zs_y\\
c_ys_z&c_xc_z+s_xs_ys_z&c_xs_ys_z-c_zs_z\\
-s_y&c_ys_x&c_xc_y
\end{matrix}\right]
$

$
R_n^b = {R_b^n}^T$

其中：

1. $s_x,c_x,s_y,c_y,s_z,c_z$分别代表着$sin(x),cos(x),sin(y),cos(y),sin(z),cos(z)$
2. $x,y,z$分别代表着$roll,pitch,yaw$
